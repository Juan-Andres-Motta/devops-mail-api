#!/bin/sh

# Exit if already in hook context
if [ -n "$HOOK_ACTIVE" ]; then
  exit 0
fi
export HOOK_ACTIVE=1

# Get target branch
REMOTE_BRANCH=$(echo "$1" | sed 's/.*\///')

# Bump version
CURRENT_VERSION=$(cat version.txt)
if [ "$REMOTE_BRANCH" = "main" ]; then
  NEW_VERSION=$(echo "$CURRENT_VERSION" | awk -F. '{printf "%d.%d.%d", $1+1, 0, 0}')
else
  NEW_VERSION=$(echo "$CURRENT_VERSION" | awk -F. '{printf "%d.%d.%d", $1, $2+1, 0}')
fi

# Update version.txt
echo "$NEW_VERSION" > version.txt

# Amend commit and force-push WITHOUT re-triggering hooks
git add version.txt
git commit --amend --no-edit --allow-empty
git push --force --no-verify origin HEAD

unset HOOK_ACTIVE
exit 0