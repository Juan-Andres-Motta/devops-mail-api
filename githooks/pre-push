#!/bin/sh

# Exit if already in hook context
if [ -n "$HOOK_ACTIVE" ]; then
  exit 0
fi
export HOOK_ACTIVE=1

# Get target branch
while read -r local_ref local_sha remote_ref remote_sha; do
  REMOTE_BRANCH=$(echo "$remote_ref" | sed 's/.*\///')
done

# Bump version
CURRENT_VERSION=$(cat version.txt)
if [ "$REMOTE_BRANCH" = "main" ]; then
  NEW_VERSION=$(echo "$CURRENT_VERSION" | awk -F. '{printf "%d.%d.%d", $1+1, 0, 0}')
else
  NEW_VERSION=$(echo "$CURRENT_VERSION" | awk -F. '{printf "%d.%d.%d", $1, $2+1, 0}')
fi

# Update version.txt
echo "$NEW_VERSION" > version.txt

# Amend commit and force-push SAFELY
git add version.txt
git commit --amend --no-edit --allow-empty

# Get latest remote state to avoid ref conflicts
git fetch origin

# Force-push with lease (safer than --force)
git push --force-with-lease origin HEAD

unset HOOK_ACTIVE
exit 0